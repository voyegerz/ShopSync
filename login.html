<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Store | By Neeraj</title>

    <!-- main stylesheet -->
    <link rel="stylesheet" href="styles/style.css" />

    <!-- page stylesheet  -->
    <link rel="stylesheet" href="styles/register.css" />
    <link rel="stylesheet" href="styles/login.css" />
  </head>
  <body>
    <!-- header start -->
    <div class="header">
      <!-- logo  -->
      <div class="logo">
        <span id="logo-cursib">Shop</span>
        <span id="logo-name">Sync</span>
      </div>

      <!-- nav links  -->
      <nav class="nav-links">
        <a href="index.html">HOME</a>
        <a href="shop.html">EXPLORE</a>
      </nav>

      <!-- searchbar  -->
      <div class="search-container">
        <input type="text" name="searchbar" id="main-search" />
        <img id="search-icon" src="assets/icons/search (2).png" alt="" />
      </div>

      <!-- cart  -->
      <div class="cart" style="display: none">
        <a href="cart.html"
          ><img src="assets/icons/cart.png" alt="" class="cart-btn"
        /></a>
      </div>

      <div class="dashboard" style="display: none">
        <a href="dashboard.html">
          <img src="assets/icons/dashboard-icon.png" class="cart-btn" alt="" />
        </a>
      </div>

      <!-- login  -->
      <a class="login-btn" id="login-btn" href="login.html">Log In</a>

      <!-- logout -->
      <a class="login-btn log-out" id="logout-btn" style="display: none"
        >Log Out</a
      >
    </div>
    <!-- header end  -->

    <!-- register start  -->
    <div class="register">
      <div class="register-left">
        <img src="assets/illustrations/login.svg" alt="" />
      </div>

      <div class="register-right">
        <h1 class="heading">LOG IN</h1>

        <label for="role-select">Select Role</label>
        <div class="role-select">
          <label for="role-user">User</label>
          <input type="radio" name="role" id="role-user" value="user" />
          <label for="role-user">Shop keeper</label>
          <input
            type="radio"
            name="role"
            id="role-shopkeeper"
            value="shop_keeper"
          />
        </div>

        <label for="uemail">User Email</label>
        <input type="email" name="uemail" id="uemail" />

        <label for="upass">Password</label>
        <input type="password" name="upass" id="upass" />

        <button class="login-btn-page btn" id="login-btn-page">Log In</button>

        <a href="register.html"
          >Donâ€™t have account yet ...
          <span id="login-link">Register Now</span></a
        >
      </div>
    </div>

    <!-- footer start  -->
    <div class="footer">
      <!-- footer-text  -->
      <div class="footer-text">
        <!-- logo  -->
        <div class="logo footer-logo">
          <span id="logo-cursib">Books by</span>
          <span id="logo-name">Neeraj</span>
        </div>

        <p class="footer-text-para">
          A Curated Book Collection Where anyone can see the books buy the books
          and save them into there wishlist to buy later. <br /><br />
          <span id="dev-name-heading">Designed & Developed By</span><br />
          <span id="dev-name">Neeraj Kumar</span>
        </p>

        <div class="share-links">
          <a href=""> <img src="assets/icons/linkedin.png" alt="" /></a>
          <a href=""> <img src="assets/icons/facebook.png" alt="" /></a>
          <a href=""> <img src="assets/icons/whatsapp.png" alt="" /></a>
          <a href=""> <img src="assets/icons/instagram.png" alt="" /></a>
          <!-- <img
            class="profile-footer"
            src="assets/images/IMG_20221205_225853_077.jpg"
            alt=""
          /> -->
        </div>

        <!-- bg circle 4  -->
        <div class="bg-circle-4 effect"></div>
      </div>

      <!-- footer links  -->
      <div class="footer-links">
        <div class="product-links links-cat">
          <p class="link-heading">Product</p>
          <a href="" class="link">Download</a>
          <a href="" class="link">Pricing</a>
          <a href="" class="link">Server</a>
        </div>

        <div class="user-links links-cat">
          <p class="link-heading">User</p>
          <a href="" class="footer-register">Register</a>
          <a href="" class="login">Login</a>
          <a href="" class="shop">Shop</a>
          <a href="" class="link-category">Categories</a>
        </div>

        <div class="engage-links links-cat">
          <p class="link-heading">Engage</p>
          <a href="" class="about-us">About Us</a>
          <a href="" class="contact-us"> Contact Us</a>
        </div>
      </div>
    </div>

    <!-- copyright  -->
    <p class="copyright">All Copyrightes Reserved @ Neeraj Kumar ;]</p>

    <!-- background circles effect  -->
    <div class="bg-circle-1 effect"></div>

    <script>
      //LOGOUT START//////////////////////////////////////////////////////////////
      //LOGOUT SECTION CODE START////////////////////////////////////////////////////////////////
      const login_btn = document.querySelector("#login-btn");
      const logout_btn = document.querySelector("#logout-btn");
      const header = document.querySelector(".header");
      const cart = document.querySelector(".cart");
      const dashboard = document.querySelector(".dashboard");

      // on page load do the following
      function onPageLoad() {
        const name_data_element = document.createElement("p");

        name_data_element.classList.add("session-name");

        const session_id = window.sessionStorage.getItem("id");
        const session_name = window.sessionStorage.getItem("name");
        const role = window.sessionStorage.getItem("role");
        const status = window.sessionStorage.getItem("status");

        if (status == "success") {
          if (session_name != null) {
            name_data_element.textContent = "Hi\n" + session_name.split(" ")[0];
          }
          header.appendChild(name_data_element);

          if (session_id && session_name != null) {
            login_btn.style.display = "none";
            logout_btn.style.display = "block";
          }
          if (role == "user") {
            cart.style.display = "block";
          } else if (role == "shop_keeper") {
            cart.style.display = "block";
            dashboard.style.display = "block";
          }
        } else if (status == "fail") {
          alert(" Failed to login , Invalid Username or Password.");
        }
      }
      window.onload = onPageLoad();

      async function logOut() {
        try {
          const response = await fetch(
            "https://shopsync.pythonanywhere.com/logout"
          );

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const result = await response.json();
          console.log(result);
          alert(result["msg"]);
        } catch (error) {
          console.error("Error:", error);
          alert(
            "Error registering user. Please check the console for details."
          );
        }
      }

      logout_btn.addEventListener("click", function (event) {
        logOut().then(clearSessionAndReload);
      });

      function clearSessionAndReload() {
        sessionStorage.clear();
        window.location.reload();
      }
      //LOGOUT SECTION CODE END//////////////////////////////////////////////////////////////////////////////////////////////

      //LOGOUT END//////////////////////////////////////////////////////////////////////////////////////

      //LOGIN START//////////////////////////////////////////////////////////////
      var email = document.getElementById("uemail");
      var pass = document.getElementById("upass");
      var btn = document.getElementById("login-btn-page");

      let data = {
        email: "",
        passwd: "",
        role: "",
      };

      let res = {};

      async function loginUser(data) {
        try {
          const response = await fetch(
            "https://shopsync.pythonanywhere.com/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const result = await response.json();
          console.log(result);
          //console.log(result["msg"]);
          return result;
        } catch (error) {
          console.error("Error:", error);
          alert(
            "Error registering user. Please check the console for details."
          );
        }
      }

      btn.addEventListener("click", (event) => {
        var role = document.querySelector('input[name="role"]:checked');

        if (role != null) {
          data = {
            email: email.value,
            passwd: pass.value,
            role: role.value,
          };
          res = loginUser(data);
          res.then(setSessionVars);
        }
        console.log(" login page btn clicked");
      });

      function setSessionVars(res) {
        if (res.msg != "Invalid Pass/Username") {
          window.sessionStorage.setItem("role", String(data.role));
          window.sessionStorage.setItem("id", String(res.id));
          window.sessionStorage.setItem("name", String(res.name));
          window.sessionStorage.setItem("status", "success");

          a = window.sessionStorage.getItem("role");
          b = window.sessionStorage.getItem("id");
          c = window.sessionStorage.getItem("name");
          d = window.sessionStorage.getItem("status");

          console.log(a);
          console.log(b);
          console.log(c);
          console.log(d);
        } else {
          window.sessionStorage.setItem("status", "fail");
          d = window.sessionStorage.getItem("status");

          console.log(d);
        }

        window.location.reload();
      }
      //LOGIN END//////////////////////////////////////////////////////////////
    </script>
  </body>
</html>
